---
import ReviewCard from "@components/ReviewCard/ReviewCard.astro";
import Layout from "@layouts/Layout.astro";
import { findReviews } from "@server/reviews";
import { getUser, updateSessionHeaders } from "@server/supabase";

const { user, session } = await getUser(Astro.request);

if (!user) {
  return Astro.redirect("/login");
}

updateSessionHeaders(Astro.response.headers, session);

const page = parseInt(Astro.url.searchParams.get("page") || "0") || 0;

const take = 10;
const skip = page * take;

const reviews = await findReviews({ skip, take, userId: user.id });
---

<Layout title="Reviews" user={user}>
  <main class="p-4 flex flex-col gap-4">
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
      {
        reviews.reviews.map((review) => (
          <ReviewCard
            album={review.album}
            artist={review.album.artist}
            review={review}
          />
        ))
      }
    </div>
  </main>
</Layout>
