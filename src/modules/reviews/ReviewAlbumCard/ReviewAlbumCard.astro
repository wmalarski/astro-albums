---
import ReviewFields from "@modules/reviews/ReviewForm/ReviewFields.astro";
import Button from "@components/Button/Button.astro";
import type { Album } from "astro:db";
import { getActionProps, actions, isInputError } from "astro:actions";

export interface Props {
  album: typeof Album.$inferSelect;
  userId: string;
}

const { album } = Astro.props;

const results = Astro.getActionResult(actions.review);
const inputErrors = isInputError(results?.error) ? results.error.fields : null;

// if (Astro.locals.formData?.get("action") === formAction) {
//   const parsed = await safeParseAsync(
//     object({
//       albumId: string(),
//       rate: number([minValue(0), maxValue(10)]),
//       text: string(),
//     }),
//     decode(Astro.locals.formData, { numbers: ["rate"] }),
//   );

//   if (parsed.success) {
//     try {
//       await createReview({ ...parsed.output, userId });
//       return Astro.redirect(paths.album(album.id));
//     } catch (error) {
//       console.error(error);
//       return Astro.redirect(paths.error);
//     }
//   }

//   console.log(parsed.issues);
// }
---

<form class="card" method="post">
  <input {...getActionProps(actions.review)} />
  <input type="hidden" name="albumId" value={album.id} />
  <ReviewFields errors={inputErrors} />
  <div class="card-actions">
    <Button type="submit">Save</Button>
  </div>
  <pre>{JSON.stringify(results, null, 2)}</pre>
</form>
